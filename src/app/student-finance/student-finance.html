<div class="p-4 md:p-6 min-h-screen text-white" dir="rtl">

    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div>
           <h2 class="text-xl md:text-2xl font-bold text-yellow-500 border-r-4 border-yellow-500 pr-3">
        إدارة المالية 
      </h2>
      <br>
      <p>
        @if(studentName()){
        الطالب /    
        {{studentName()}}
        }
    </p>

      </div>
      
     
      <div class="flex flex-col md:flex-row gap-2 justify-center md:justify-end">
        <input
          type="text"
          placeholder="اكتب اسم الطالب"
          [(ngModel)]="searchName"
          (keydown.enter)="searchStudent()"

          class="p-2 rounded-lg border border-yellow-500 bg-[#141414] text-white"
        />
        <input
          type="text"
          placeholder="السنة الدراسية"
          [(ngModel)]="year"
          class="p-2 rounded-lg border border-yellow-500 bg-[#141414] text-white"
        />
        <button
          (click)="searchStudent()"
          class="bg-yellow-400 text-black px-4 py-2 rounded-lg font-semibold hover:bg-yellow-500 transition cursor-pointer"
        >
          بحث
        </button>
      </div>
    </div>
  
    <div class="overflow-x-auto rounded-xl border border-yellow-500/20">
  
      <table class="min-w-full text-xs md:text-sm text-center border-separate border-spacing-0">
  
        <thead class="sticky top-0 z-20 bg-yellow-500 text-black">
          <tr>
            <th class="p-2 md:p-4 border-b border-yellow-600 sticky right-0 z-30 bg-yellow-500">
              المجموعة
            </th>
            @for (m of months; track m.id) {
              <th class="p-2 md:p-4 border-b border-yellow-600">
                {{ m.name }}
              </th>
            }
          </tr>
        </thead>
  
        <tbody>
          @if(!groups()!.length&&!loading()&&!studentName()){
            <tr>
                <td [attr.colspan]="months.length " class="py-20 ">
                 <div class="text-center flex md:block  items-center">
                    إبحث عن إسم طالب
                 </div>
                </td>
            </tr>
          }@else if(studentName()&&!groups()!.length&&!loading()){
            <tr>
                <td [attr.colspan]="months.length " class="py-20">
                 <div class="text-center flex md:block  items-center">
                        هذا الطالب ليس مسجل في أي مجموعة !!
                 </div>
                </td>
            </tr>
          }
          @if (loading()) {
            <tr>
              <td [attr.colspan]="months.length " class="py-20 ">
                <div class="flex md:justify-center md:items-center ">
                  <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500 ">
                  </div>
                 جار تحميل البيانات المالية...

                </div>
              </td>
            </tr>
          } @else {
            @for (g of groups(); track g.groupName) {
                <tr class="border-b border-yellow-500/10  hover:bg-[#0f0f0f]/[0.8] ">
              
                  <td class="p-3 font-semibold text-black bg-yellow-500 sticky right-0 z-100">
                    {{ g.groupName }}
                  </td>
              
                  @for (m of months; track m.id) {
                    <td class="p-3 cursor-pointer relative"
                    (dblclick)="enableEditPayment(g.groupId, m.id)">
              
                      @let payment = g.payments[m.id];
                      @if (activePayment?.groupId === g.groupId && activePayment?.month === m.id) {

                        <input type="number" 
                        [value]="g.payments[m.id].Amount_Paid"
                        class="[appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none
                         w-20 p-2 rounded-lg border border-yellow-500 bg-[#141414] text-white px-2 py-1 rounded"
                        (keydown.enter)="savePayment($event.target.valueAsNumber)"
                        />
                      }@else{
                        @if (payment?.Is_Paid) {
                            <span class="font-semibold"
                            [ngClass]="isSaving(g, m) ? 'text-yellow-400' : payment?.Is_Paid ? 'text-green-400' : 'text-red-400'">
                        ✔ {{ payment.Amount_Paid }} ج
                      </span>
                        } @else {
                          <span class="text-red-400">—</span>
                        
                      }
                    }
                    
                    </td>
                  }
                </tr>
              }
              
          }
        </tbody>
  
      </table>
    </div>
  
    <div class="mt-6 flex justify-end">
      <div class="bg-[#141414] px-6 py-4 rounded-xl border border-yellow-500/40">
        إجمالي المدفوع:
        <span class="text-yellow-400 font-bold text-xl">
          {{ totalPaid() }} ج
        </span>
      </div>
    </div>
    <div class="flex gap-2 mb-6">
      <button
        class="px-4 py-2 rounded-lg font-bold transition"
        [ngClass]="reportMode() === 'daily'
          ? 'bg-yellow-500 text-black'
          : 'bg-white/5 text-white hover:bg-yellow-500 hover:text-black'"
        (click)="reportMode.set('daily')">
        يومي
      </button>
    
      <button
        class="px-4 py-2 rounded-lg font-bold transition"
        [ngClass]="reportMode() === 'monthly'
          ? 'bg-yellow-500 text-black'
          : 'bg-white/5 text-white hover:bg-yellow-500 hover:text-black'"
        (click)="reportMode.set('monthly')">
        شهري
      </button>
    
      <button
        class="px-4 py-2 rounded-lg font-bold transition"
        [ngClass]="reportMode() === 'yearly'
          ? 'bg-yellow-500 text-black'
          : 'bg-white/5 text-white hover:bg-yellow-500 hover:text-black'"
        (click)="reportMode.set('yearly')">
        سنوي
      </button>
    </div>
    
    @for (r of cashReport(); track r.period) {
      @if (cashLoading()) {
        <div class="flex justify-center items-center py-16 gap-3 text-yellow-400">
          <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-yellow-500"></div>
          جار تحميل التقرير ...
        </div>
      }
      @else{
      <div class="mb-6 overflow-x-auto rounded-xl border border-yellow-500/30">
    
        <!-- عنوان التقرير -->
        <div class="px-4 py-3 bg-yellow-500 text-black font-bold">
          {{ r.period }}
        </div>
    
        <!-- الجدول -->
        <table class="min-w-full text-xs md:text-sm text-center border-separate border-spacing-0">
    
          <thead class="sticky top-0 z-10 bg-yellow-500 text-black">
            <tr>
              <th class="p-3 border-b border-yellow-600">
                {{ reportMode() === 'daily'
                ? 'الوقت'
                : 'التاريخ'
            }}
              </th>
                            <th class="p-3 border-b border-yellow-600">الطالب</th>
              <th class="p-3 border-b border-yellow-600">المجموعة</th>
              <th class="p-3 border-b border-yellow-600">
                شهر الدفع
              </th>
              
              <th class="p-3 border-b border-yellow-600">المبلغ</th>
            </tr>
          </thead>
    
          <tbody>
            @for (t of r.transactions; track t.createdAt + t.studentName) {
              <tr class="border-b border-yellow-500/10  transition">
                <td class="p-3 text-gray-300">
                
                  {{ reportMode() === 'daily'
                  ? (t.createdAt | date:'HH:mm:ss')
                  : (t.createdAt | date:'yyyy-MM-dd')
              }}
                              </td>
                <td class="p-3 font-semibold">
                  {{ t.studentName }}
                </td>
                <td class="p-3 text-gray-300">
                  {{ t.groupName }}
                </td>
                <td class="p-3 text-yellow-400 font-semibold">
                  {{ t.paidMonth }}
                </td>
                
                <td class="p-3 font-bold text-green-400">
                  {{ t.amount }} ج
                </td>
              </tr>
            }
          </tbody>
    
          <tfoot>
            <tr class=" font-bold">
              <td colspan="4" class="p-3 text-right text-yellow-400">
                الإجمالي — {{ r.count }} عملية
              </td>
              <td class="p-3 text-green-400 text-lg">
                {{ r.total }} ج
              </td>
            </tr>
          </tfoot>
    
        </table>
    
      </div>
    }
  }
    
  </div>
  