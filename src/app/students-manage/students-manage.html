<section class="p-6 md:p-10 min-h-screen">

    <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† + Ø¨Ø­Ø« + Ø¥Ø¶Ø§ÙØ© -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <h1 class="text-2xl font-bold text-yellow-500">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
      <div class="flex gap-3 flex-col md:flex-row">
        <input
        type="text"
        [ngModel]="studentSearch()"
        (ngModelChange)="studentSearch.set($event)"
        placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..."
        class="px-4 py-2 rounded-lg border bg-[#1f1f1f] text-white focus:outline-none focus:ring-2 focus:ring-yellow-400"
      />
      
      <select
        [ngModel]="filterGradeId()"
        (ngModelChange)="filterGradeId.set($event === 'null' ? null : $event)"
        class="px-4 py-2 rounded-lg border bg-[#1f1f1f] text-white"
      >
        <option value="null">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option>
        @for (grade of grades(); track grade.GRADE_ID) {
          <option [value]="grade.GRADE_ID">{{ grade.GRADE_NAME }}</option>
        }
      </select>
      
      
      
      
    </div>
    <button
    (click)="addStudent()"
    class="bg-[#FFC107] hover:bg-yellow-500 text-black font-semibold px-5 py-2 rounded-lg shadow">
    + Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨
  </button>
    </div>
  
    <h4 class="mb-6">
      <span class="text-2xl font-bold text-yellow-500">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: </span>
      <span class="text-2xl font-bold text-white-500">{{students().length}}</span>
    </h4>
  
    <!-- Loading -->
    @if (loading()) {
      <div class="flex justify-center items-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500"></div>
      </div>
    }
  
    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
    @else {
      <div class="overflow-x-auto taa rounded-xl shadow hidden md:block max-h-[61vh] overflow-y-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-[#FFC107] text-white sticky top-0 z-[1000]">
            <tr>
              <th class="px-4 py-3">Ø§Ù„Ø§Ø³Ù…</th>
              <th class="px-4 py-3">Ø§Ù„Ù‡Ø§ØªÙ</th>
              <th class="px-4 py-3">Ø§Ù„ØµÙ</th>
              <th class="px-4 py-3 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            @for (student of filteredStudents(); track student.STUDENT_ID) {
              <tr class="border-b border-yellow-500 hover:bg-gray-800 transition-colors" [class.bg-gray-700]="editingStudentId() === student.STUDENT_ID">
                <td class="px-4 py-3">
                  @if (editingStudentId() === student.STUDENT_ID) {
                    <input [(ngModel)]="newStudent().NAME" class="w-full px-2 py-1 border rounded text-black">
                  } @else {
                    {{ student.NAME }}
                  }
                </td>
                <td class="px-4 py-3">
                  @if (editingStudentId() === student.STUDENT_ID) {
                    <input [(ngModel)]="newStudent().PHONE" class="w-full px-2 py-1 border rounded text-black">
                  } @else {
                    {{ student.PHONE }}
                  }
                </td>
                <td class="px-4 py-3">
                  @if (editingStudentId() === student.STUDENT_ID) {
                    <!-- Dropdown Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ -->
                    <select
                      [(ngModel)]="newStudent().GRADE_ID"
                      class="w-full px-2 py-1 border rounded text-black"
                    >
                      @for (grade of grades(); track grade.GRADE_ID) {
                        <option [value]="grade.GRADE_ID">{{ grade.GRADE_NAME }}</option>
                      }
                    </select>
                  } @else {
                    <!-- Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„ØµÙ -->
                    {{ getGradeName(student.GRADE_ID) }}
                  }
                </td>
                
                <td class="px-4 py-3 text-center flex gap-2 justify-center">
                  @if (editingStudentId() === student.STUDENT_ID) {
                    <button (click)="saveStudent()" class="px-2 py-1 bg-green-500 text-white rounded">Ø­ÙØ¸</button>
                    <button (click)="cancelAdd()" class="px-2 py-1 bg-gray-500 text-white rounded">Ø¥Ù„ØºØ§Ø¡</button>
                  } @else {
                    <button (click)="editStudent(student)" class="px-2 py-1 bg-blue-500 text-white rounded">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button (click)="openStudentReport(student)" class="px-2 py-1 bg-yellow-500 text-white rounded">ØªÙ‚Ø±ÙŠØ±</button>
                    <button (click)="deleteStudent(student)" class="px-2 py-1 bg-red-500 text-white rounded">Ø­Ø°Ù</button>
                    
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
  
      <!-- Cards Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
      <div class="md:hidden space-y-4 w-full">
        @for (student of filteredStudents(); track student.STUDENT_ID) {
          <div class="bg-[#1f1f1f] rounded-xl p-4 shadow border border-yellow-500/20">
            @if (editingStudentId() === student.STUDENT_ID) {
              <div class="space-y-3">
                <input [(ngModel)]="newStudent().NAME" placeholder="Ø§Ù„Ø§Ø³Ù…" class="w-full p-2 rounded border">
                <input [(ngModel)]="newStudent().PHONE" placeholder="Ø§Ù„Ù‡Ø§ØªÙ" class="w-full p-2 rounded border">
                <select
                [(ngModel)]="newStudent().GRADE_ID"
                class="w-full px-2 py-1 border rounded text-black"
              >
                @for (grade of grades(); track grade.GRADE_ID) {
                  <option [value]="grade.GRADE_ID">{{ grade.GRADE_NAME }}</option>
                }
              </select>                <div class="flex gap-2 pt-2">
                  <button (click)="saveStudent()" class="flex-1 bg-green-500 py-2 rounded text-white">Ø­ÙØ¸</button>
                  <button (click)="cancelAdd()" class="flex-1 bg-gray-500 py-2 rounded text-white">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
              </div>
            } @else {
              <div class="mb-2 font-bold text-lg">{{ student.NAME }}</div>
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div>ğŸ“ {{ student.PHONE }}</div>
                <div>ğŸ« {{ getGradeName(student.GRADE_ID) }}</div>
              </div>
              <div class="flex gap-2 mt-2">
                <button (click)="editStudent(student)" class="flex-1 bg-blue-500 py-2 rounded text-white">ØªØ¹Ø¯ÙŠÙ„</button>
                <button (click)="editStudent(student)" class="flex-1 bg-yellow-500 py-2 rounded text-white">ØªÙ‚Ø±ÙŠØ±</button>
                <button (click)="deleteStudent(student)" class="flex-1 bg-red-500 py-2 rounded text-white">Ø­Ø°Ù</button>
              </div>
            }
          </div>
        }
      </div>
    }


    @if (showReport()) {
      <!-- Overlay -->
      <div
        class="fixed inset-0 bg-black/70 z-[9999] flex items-center justify-center">
    
        <!-- Modal -->
        <div
          class="bg-[#1f1f1f] w-[95%] md:w-[70%] max-h-[85vh] overflow-y-auto
                 rounded-xl shadow-xl p-6 relative overflow-y-auto [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]">
    
          <!-- Close -->
          <button
            (click)="closeReport()"
            class="absolute top-3 left-3 text-white text-xl">
            âœ•
          </button>
    
          <!-- Header -->
          <h2 class="text-2xl font-bold text-yellow-400 mb-2">
            ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨
          </h2>
    
          @if (selectedStudent()) {
            <p class="text-gray-300 mb-4">
              {{ selectedStudent()!.NAME }}
            </p>
          }
    
          <!-- Loading -->
          @if (!studentReport()) {
            <div class="flex justify-center py-10">
              <div class="animate-spin h-10 w-10 border-b-2 border-yellow-400 rounded-full"></div>
            </div>
          }
    
          <!-- Report Content -->
          @else {
            <!-- Overall Rating -->
            <div class="mb-6">
              <h3 class="font-bold text-lg mb-1">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…</h3>
              <div class="flex items-center gap-2">
                <span class="text-xl font-bold">
                  {{ studentReport()!.overallRating }} / 5
                </span>
                <div class="flex">
                  @for (i of [1,2,3,4,5]; track i) {
                    <span
                      class="text-2xl"
                      [class.text-yellow-400]="i <= studentReport()!.overallRating"
                      [class.text-gray-600]="i > studentReport()!.overallRating">
                      â˜…
                    </span>
                  }
                </div>
              </div>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-6">
              <div class="bg-green-600/20 border border-green-500 rounded-lg p-4 text-center">
                <div class="text-3xl font-bold text-green-400">
                  {{ studentReport()!.attendance?.PRESENT_COUNT || 0 }}
                </div>
                <div class="text-sm text-gray-300">Ø­Ø¶ÙˆØ±</div>
              </div>
            
              <div class="bg-yellow-600/20 border border-yellow-500 rounded-lg p-4 text-center">
                <div class="text-3xl font-bold text-yellow-400">
                  {{ studentReport()!.attendance?.LATE_COUNT || 0 }}
                </div>
                <div class="text-sm text-gray-300">ØªØ£Ø®ÙŠØ±</div>
              </div>
            
              <div class="bg-red-600/20 border border-red-500 rounded-lg p-4 text-center">
                <div class="text-3xl font-bold text-red-400">
                  {{ studentReport()!.attendance?.ABSENT_COUNT || 0 }}
                </div>
                <div class="text-sm text-gray-300">ØºÙŠØ§Ø¨</div>
              </div>
            </div>
            
            <!-- Groups -->
            @for (group of studentReport()!.groups; track group.GROUP_ID) {
              <div class="border border-yellow-500/30 rounded-lg p-4 mb-4">
    
                <div class="flex justify-between items-center mb-2">
                  <h4 class="font-bold text-lg">
                    {{ group.GROUP_NAME }}
                  </h4>
    
                  <div class="flex items-center gap-1">
                    @for (i of [1,2,3,4,5]; track i) {
                      <span
                        class="text-xl"
                        [class.text-yellow-400]="i <= group.AVG_RATING"
                        [class.text-gray-600]="i > group.AVG_RATING">
                        â˜…
                      </span>
                    }
                    <span class="text-sm text-gray-400 ml-2">
                      ({{ group.AVG_RATING }}/5)
                    </span>
                  </div>
                  
                </div>
    
                <!-- Notes -->
                <div class="text-sm text-gray-300 whitespace-pre-line">
                  {{ group.NOTES || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª' }}
                </div>
              </div>
            }
    
            <!-- Actions -->
            <div class="flex justify-end gap-3 mt-6">
              <button
                (click)="generatePdf(studentReport()!)"
                class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg">
                ØªØ­Ù…ÙŠÙ„ PDF
              </button>
    
              <button
                (click)="closeReport()"
                class="bg-gray-600 hover:bg-gray-700 text-white px-5 py-2 rounded-lg">
                Ø¥ØºÙ„Ø§Ù‚
              </button>
            </div>
          }
        </div>
      </div>
    }
    
  </section>
  