<section class="p-6 md:p-10 min-h-screen text-right" dir="rtl">
  <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† + Ø¨Ø­Ø« + Ø¥Ø¶Ø§ÙØ© -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <h1 class="text-2xl font-bold text-yellow-500">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h1>
    <div class="flex flex-col justify-between gap-2">
      <input 
        type="text" 
        [ngModel]="searchText()" 
        (ngModelChange)="searchText.set($event)" 
        placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¬Ù…ÙˆØ¹Ø©..." 
        class="px-4 py-2 rounded-lg border border-gray-600 bg-[#1f1f1f] text-white focus:outline-none focus:ring-2 focus:ring-yellow-400">
       <div class="flex w-full gap-4">
        <select 
        id="grads"
        [ngModel]="filterGradeId()" 
        (ngModelChange)="filterGradeId.set($event === 'null' ? null : +$event)" 
        class="px-4 w-[50%] py-2 rounded-lg border bg-[#1f1f1f] text-white focus:outline-none focus:ring-2 focus:ring-yellow-400"
      >

        <option value="null">ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</option>
        @for (grade of grades(); track grade.GRADE_ID) {
          <option [value]="grade.GRADE_ID">{{ grade.GRADE_NAME }}</option>
        }
      </select>
      
      <select 
        [ngModel]="filterTeacherId()" 
        (ngModelChange)="filterTeacherId.set($event === 'null' ? null : +$event)" 
        class="px-4 w-[50%] py-2 rounded-lg border bg-[#1f1f1f] text-white focus:outline-none focus:ring-2 focus:ring-yellow-400"
      >
        <option value="null">ÙƒÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</option>
        @for (teacher of teachers(); track teacher.TEACHER_ID) {
          <option [value]="teacher.TEACHER_ID">{{ teacher.TEACHER_NAME }}</option>
        }
      </select>
    </div>
   
    </div>
    <button
    (click)="addGroup()"
    class="bg-[#FFC107] hover:bg-yellow-500 text-black font-semibold px-5 py-2 rounded-lg shadow">
    + Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø©
  </button>
  </div>

  <!-- Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª -->
  <h4 class="mb-6">
    <span class="text-2xl font-bold text-yellow-500">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª: </span>
    <span class="text-2xl font-bold text-white">{{ groups().length }}</span>
  </h4>

  <!-- Loader -->
  @if (loading()) {
    <div class="flex justify-center items-center py-20">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500"></div>
    </div>
  } @else {

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„ÙƒÙˆÙ…Ø¨ÙŠÙˆØªØ± -->
    <div class="overflow-x-auto taa rounded-xl shadow hidden md:block max-h-[61vh] overflow-y-auto">
      <table class="min-w-full text-sm text-right">
        <thead class="bg-[#FFC107] text-white sticky top-0 z-10">
          <tr>
            <th class="px-4 py-3">Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
            <th class="px-4 py-3">Ø§Ù„ØµÙ</th>
            <th class="px-4 py-3">Ø§Ù„Ù…Ø¯Ø±Ø³</th>
            <th class="px-4 py-3">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
            <th class="px-4 py-3">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</th>


            <th class="px-4 py-3 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody class="text-white">
          @for (group of filteredGroups(); track group.GROUP_ID) {
            <tr class="border-b border-yellow-500/20 hover:bg-gray-800 transition-colors"
                [class.bg-gray-700]="editingGroupId() === group.GROUP_ID">

              <!-- Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© -->
              <td class="px-4 py-3">
                @if (editingGroupId() === group.GROUP_ID) {
                  <input [ngModel]="formGroup().GROUP_NAME"
                         (ngModelChange)="updateFormField('GROUP_NAME', $event)"
                         placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©"
                         class="w-full px-2 py-1 border rounded text-black">
                } @else {
                  {{ group.GROUP_NAME }}
                }
              </td>

              <!-- Ø§Ù„ØµÙ -->
              <td class="px-4 py-3">
                @if (editingGroupId() === group.GROUP_ID) {
                  <select [ngModel]="formGroup().GRADE_ID"
                          (ngModelChange)="updateFormField('GRADE_ID', $event)"
                          class="w-full px-2 py-1 border rounded text-black">
                    @for (grade of grades(); track grade.GRADE_ID) {
                      <option [value]="grade.GRADE_ID">{{ grade.GRADE_NAME }}</option>
                    }
                  </select>
                } @else {
                  {{ getGradeName(group.GRADE_ID) }}
                }
              </td>

              <!-- Ø§Ù„Ù…Ø¯Ø±Ø³ -->
              <td class="px-4 py-3">
                @if (editingGroupId() === group.GROUP_ID) {
                  <select [ngModel]="formGroup().TEACHER_ID"
                          (ngModelChange)="updateFormField('TEACHER_ID', $event)"
                          class="w-full px-2 py-1 border rounded text-black">
                    @for (teacher of teachers(); track teacher.TEACHER_ID) {
                      <option [value]="teacher.TEACHER_ID">{{ teacher.TEACHER_NAME }}</option>
                    }
                  </select>
                } @else {
                  {{ getTeacherName(group.TEACHER_ID) }}
                }
              </td>
              <td class="px-4 py-3">
               {{getTeacherSubject(group.TEACHER_ID)}}
              </td>
              <td class="px-4 py-3">
                {{group.STUDENTS_COUNT}}
               </td>

              <!-- Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
              <td class="px-4 py-3 text-center flex gap-2 justify-center">
                @if (editingGroupId() === group.GROUP_ID) {
                  <button (click)="saveGroup()" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">Ø­ÙØ¸</button>
                  <button (click)="cancel()" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600">Ø¥Ù„ØºØ§Ø¡</button>
                } @else {
                  <button (click)="editGroup(group)" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">ØªØ¹Ø¯ÙŠÙ„</button>
                  <button (click)="deleteGroup(group)" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">Ø­Ø°Ù</button>
                  <button (click)="openStudentsPopupForGroup(group)" class="px-3 py-1 bg-yellow-500 text-black rounded hover:bg-yellow-400">Ø§Ù„Ø·Ù„Ø§Ø¨</button>
                }
              </td>

            </tr>
          } @empty {
            <tr>
              <td colspan="4" class="text-center py-10 text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- ÙƒØ±ÙˆØª Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
    <div class="md:hidden space-y-4 w-full">
      @for (group of filteredGroups(); track group.GROUP_ID) {
        <div class="bg-[#1f1f1f] rounded-xl p-4 shadow border border-yellow-500/20 text-white">
          @if (editingGroupId() === group.GROUP_ID) {
            <div class="space-y-3">
              <input [ngModel]="formGroup().GROUP_NAME" (ngModelChange)="updateFormField('GROUP_NAME', $event)" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©" class="w-full p-2 rounded border text-black">
              <select [ngModel]="formGroup().GRADE_ID" (ngModelChange)="updateFormField('GRADE_ID', $event)" class="w-full p-2 rounded border text-black">
                @for (grade of grades(); track grade.GRADE_ID) {
                  <option [value]="grade.GRADE_ID">{{ grade.GRADE_NAME }}</option>
                }
              </select>
              <select [ngModel]="formGroup().TEACHER_ID" (ngModelChange)="updateFormField('TEACHER_ID', $event)" class="w-full p-2 rounded border text-black">
                @for (teacher of teachers(); track teacher.TEACHER_ID) {
                  <option [value]="teacher.TEACHER_ID">{{ teacher.TEACHER_NAME }}</option>
                }
              </select>
              <div class="flex gap-2 pt-2">
                <button (click)="saveGroup()" class="flex-1 bg-green-500 py-2 rounded text-white font-bold">Ø­ÙØ¸</button>
                <button (click)="cancel()" class="flex-1 bg-gray-500 py-2 rounded text-white font-bold">Ø¥Ù„ØºØ§Ø¡</button>
              </div>
            </div>
          } @else {
            <div class="mb-2 font-bold text-lg text-yellow-500">{{ group.GROUP_NAME }}</div>
            <div class="grid grid-cols-1 gap-2 text-sm">
              <div>ğŸ« Ø§Ù„ØµÙ:  {{ getGradeName(group.GRADE_ID) }}
              </div>
              <div>ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¯Ø±Ø³:  {{ getTeacherName(group.TEACHER_ID) }}
              </div>
              <div>ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø§Ø¯Ø©:  {{getTeacherSubject(group.TEACHER_ID)}}
              </div>
              <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ : {{group.STUDENTS_COUNT}}
              </div>
              
            </div>
            <div class="flex gap-2 mt-4">
              <button (click)="editGroup(group)" class="flex-1 bg-blue-500 py-2 rounded text-white">ØªØ¹Ø¯ÙŠÙ„</button>
              <button (click)="deleteGroup(group)" class="flex-1 bg-red-500 py-2 rounded text-white">Ø­Ø°Ù</button>
              <button (click)="openStudentsPopupForGroup(group)" class="flex-1 bg-yellow-500 py-2 rounded text-black">Ø§Ù„Ø·Ù„Ø§Ø¨</button>
            </div>
          }
        </div>
      }
    </div>
  }
</section>

<!-- Pop Up Ù„Ù„Ø·Ù„Ø§Ø¨ -->
@if (showStudentsPopup()) {
  <div class="fixed inset-0 bg-black/60 flex justify-center items-start pt-16 z-1000">
    <div class="bg-[#1f1f1f] rounded-2xl p-6 w-11/12 md:w-2/3 max-h-[85vh] overflow-y-auto shadow-lg border border-yellow-500/20">

      <!-- Header -->
      <div class="flex justify-between items-center mb-5">
        <div>
          <h3 class="text-xl font-bold text-yellow-500">
            Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: {{ currentGroup()?.GROUP_NAME }}
          </h3>
          <div class="text-sm text-gray-300 mt-1">
            Ø§Ù„ØµÙ: <span class="text-white font-semibold">{{ getGradeName(currentGroup()?.GRADE_ID || 0) }}</span>
            <br>
             Ø§Ù„Ù…Ø¯Ø±Ø³: <span class="text-white font-semibold">{{ getTeacherName(currentGroup()?.TEACHER_ID || 0) }}</span>
          </div>
        </div>

        <button (click)="closeStudentsPopup()" class="p-2 text-yellow-500 hover:bg-yellow-500/10 rounded-full transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-6 w-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>        </button>
      </div>

      <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- âœ… Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© -->
        @if (loading2()) {
          <div class="flex justify-center items-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500"></div>
          </div>
        } @else {
        <div class="bg-[#161616] rounded-xl p-4 border border-yellow-500/10">
          <div class="flex items-center justify-between mb-3">
            <h4 class="text-yellow-400 font-bold">Ø·Ù„Ø§Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h4>
            <span class="text-gray-300 text-sm">({{ groupStudents().length }})</span>
          </div>

          <input
            type="text"
            [ngModel]="groupStudentsSearch()"
            (ngModelChange)="groupStudentsSearch.set($event)"
            placeholder="Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©..."
            class="w-full p-2 mb-3 rounded border border-gray-600 bg-[#1f1f1f] text-white focus:outline-none focus:ring-2 focus:ring-yellow-400"
          >

          <div class="space-y-2">
            @for (s of filteredGroupStudents(); track s.STUDENT_ID) {
              <div class="flex items-center justify-between bg-[#1f1f1f] border border-yellow-500/10 rounded-lg p-2">
                <div class="text-white">
                  <div class="font-semibold">{{ s.NAME }}</div>
                  <div class="text-xs text-gray-400">ğŸ“ {{ s.PHONE || 'â€”' }}</div>
                </div>

                <!--  Ø²Ø± Ø¥Ø²Ø§Ù„Ø© -->
                <button
                  (click)="removeStudentFromGroup(s)"
                  class="px-3 py-1 rounded bg-red-500 text-white hover:bg-red-600 text-sm"
                >
                  Ø¥Ø²Ø§Ù„Ø©
                </button>
              </div>
            }

            @if (filteredGroupStudents().length === 0) {
              <div class="text-gray-400 text-sm py-4 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>
            }
          </div>
        </div>
      }
      @if (loading2()) {
        <div class="flex justify-center items-center py-20">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500"></div>
        </div>
      } @else {
        <div class="bg-[#161616] rounded-xl p-4 border border-yellow-500/10">
          <div class="flex items-center justify-between mb-3">
            <h4 class="text-yellow-400 font-bold">Ø·Ù„Ø§Ø¨ Ù†ÙØ³ Ø§Ù„ØµÙ Ù„Ù„Ø¥Ø¶Ø§ÙØ©</h4>
            <span class="text-gray-300 text-sm">({{ eligibleStudents().length }})</span>
          </div>

          <input
            type="text"
            [ngModel]="eligibleStudentsSearch()"
            (ngModelChange)="eligibleStudentsSearch.set($event)"
            placeholder="Ø¨Ø­Ø« ÙÙŠ Ø·Ù„Ø§Ø¨ Ø§Ù„ØµÙ..."
            class="w-full p-2 mb-3 rounded border border-gray-600 bg-[#1f1f1f] text-white focus:outline-none focus:ring-2 focus:ring-yellow-400"
          >

          <div class="space-y-2">
            @for (s of filteredEligibleStudents(); track s.STUDENT_ID) {
              <div class="flex items-center justify-between bg-[#1f1f1f] border border-yellow-500/10 rounded-lg p-2">
                <div class="text-white">
                  <div class="font-semibold">{{ s.NAME }}</div>
                  <div class="text-xs text-gray-400">ğŸ“ {{ s.PHONE || 'â€”' }}</div>
                </div>

                <button
                  (click)="addStudentToGroup(s)"
                  class="px-3 py-1 rounded bg-yellow-500 text-black hover:bg-yellow-400 text-sm font-semibold"
                >
                  Ø¥Ø¶Ø§ÙØ©
                </button>
              </div>
            }

            @if (filteredEligibleStudents().length === 0) {
              <div class="text-gray-400 text-sm py-4 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>
            }
          </div>
        </div>
      }
      </div>

    </div>
  </div>
}
